<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AggrMeter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spectator-api</a> &gt; <a href="index.source.html" class="el_package">com.netflix.spectator.api</a> &gt; <span class="el_source">AggrMeter.java</span></div><h1>AggrMeter.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2015 Netflix, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.netflix.spectator.api;

import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.concurrent.ConcurrentLinkedQueue;

/**
 * Composite meter that computes a sum aggregate of the overlapping measurements in meters in the
 * set. This is typically used to combine the values of gauges that share the same id.
 */
class AggrMeter implements Meter {
  private final Id id;
  private final ConcurrentLinkedQueue&lt;Meter&gt; queue;

  /** Create a new instance. */
<span class="fc" id="L32">  AggrMeter(Id id) {</span>
<span class="fc" id="L33">    this.id = id;</span>
<span class="fc" id="L34">    this.queue = new ConcurrentLinkedQueue&lt;&gt;();</span>
<span class="fc" id="L35">  }</span>

  @Override public Id id() {
<span class="fc" id="L38">    return id;</span>
  }

  @Override public Iterable&lt;Measurement&gt; measure() {
<span class="fc" id="L42">    Map&lt;Id, Measurement&gt; measurements = new HashMap&lt;&gt;();</span>
<span class="fc" id="L43">    Iterator&lt;Meter&gt; iter = queue.iterator();</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">    while (iter.hasNext()) {</span>
<span class="fc" id="L45">      Meter meter = iter.next();</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">      if (meter.hasExpired()) {</span>
<span class="nc" id="L47">        iter.remove();</span>
      } else {
<span class="fc bfc" id="L49" title="All 2 branches covered.">        for (Measurement m : meter.measure()) {</span>
<span class="fc" id="L50">          Measurement prev = measurements.get(m.id());</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">          if (prev == null) {</span>
<span class="fc" id="L52">            measurements.put(m.id(), m);</span>
          } else {
<span class="fc" id="L54">            double v = prev.value() + m.value();</span>
<span class="fc" id="L55">            measurements.put(prev.id(), new Measurement(prev.id(), prev.timestamp(), v));</span>
          }
<span class="fc" id="L57">        }</span>
      }
<span class="fc" id="L59">    }</span>
<span class="fc" id="L60">    return measurements.values();</span>
  }

  @Override public boolean hasExpired() {
<span class="nc" id="L64">    return queue.isEmpty();</span>
  }

  /** Adds a meter to the set included in the aggregate. */
  void add(Meter m) {
<span class="fc" id="L69">    queue.add(m);</span>
<span class="fc" id="L70">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>